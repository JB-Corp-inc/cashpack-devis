<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CashPack — Création Devis</title>
<style>
  :root { --bg:#0b0f14; --card:#121821; --muted:#94a3b8; --text:#e5e7eb; --accent:#10b981; --danger:#ef4444; }
  body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto; background:var(--bg); color:var(--text); }
  .wrap { max-width:900px; margin:40px auto; padding:20px; }
  .card { background:var(--card); border-radius:16px; padding:24px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
  h1 { margin:0 0 12px; font-size:28px; }
  .muted { color:var(--muted); font-size:14px; margin-bottom:20px; }
  .grid { display:grid; gap:12px; grid-template-columns: 1fr 1fr; }
  .grid-3 { grid-template-columns: 2fr 1fr 1fr; }
  label { font-size:13px; color:var(--muted); display:block; margin-bottom:6px; }
  input, textarea, select { width:100%; padding:10px 12px; border-radius:10px; border:1px solid #1f2937; background:#0f141b; color:var(--text); outline:none; }
  textarea { min-height:90px; }
  .row { margin:14px 0; }
  .btn { background:var(--accent); color:#04130e; border:none; padding:12px 16px; border-radius:12px; font-weight:700; cursor:pointer; }
  .btn.secondary { background:#1f2937; color:var(--text); }
  .btn.danger { background:var(--danger); color:#fff; }
  table { width:100%; border-collapse: collapse; margin-top:10px; }
  th, td { padding:10px; border-bottom:1px solid #1f2937; text-align:left; }
  tfoot td { font-weight:700; }
  .right { text-align:right; }
  .flex { display:flex; gap:8px; align-items:center; }
  .pill { font-size:12px; background:#0f141b; border:1px solid #1f2937; padding:6px 10px; border-radius:999px; color:var(--muted); }
  .ok { color:var(--accent); }
  .err { color:var(--danger); }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Créer un devis</h1>
      <div class="muted">CashPack — Devis ➜ Facture ➜ Relances automatiques</div>

      <!-- ENTREPRISE -->
      <div class="grid">
        <div class="row">
          <label>Entreprise (affichée sur le devis)</label>
          <input id="company_name" placeholder="Ex: SARL Dupont Bâtiment"/>
        </div>
        <div class="row">
          <label>Email entreprise (reçoit la prévisualisation)</label>
          <input id="company_email" type="email" placeholder="devis@entreprise.fr"/>
        </div>
        <div class="row">
          <label>Téléphone</label>
          <input id="company_phone" placeholder="+33 ..."/>
        </div>
        <div class="row">
          <label>SIRET</label>
          <input id="company_siret" placeholder="123 456 789 00012"/>
        </div>
      </div>

      <!-- CLIENT -->
      <div class="grid">
        <div class="row">
          <label>Client — Nom</label>
          <input id="client_name" placeholder="Mme Martin"/>
        </div>
        <div class="row">
          <label>Client — Email</label>
          <input id="client_email" type="email" placeholder="client@email.fr"/>
        </div>
        <div class="row">
          <label>Client — Téléphone</label>
          <input id="client_phone" placeholder="+33 ..."/>
        </div>
        <div class="row">
          <label>Chantier / Objet</label>
          <input id="site_name" placeholder="Rénovation salle de bain"/>
        </div>
      </div>

      <!-- LIGNES -->
      <div class="row">
        <div class="flex">
          <div class="pill">Lignes du devis</div>
          <button class="btn secondary" id="addItem">+ Ajouter une ligne</button>
        </div>
        <table id="itemsTable">
          <thead>
            <tr><th>Désignation</th><th class="right">Qté</th><th class="right">PU HT (€)</th></tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr><td class="right" colspan="2">Sous-total HT</td><td class="right" id="subtotal">0.00</td></tr>
            <tr><td class="right" colspan="2">TVA (%)</td><td class="right"><input id="tva_rate" value="10" style="width:80px; text-align:right"/></td></tr>
            <tr><td class="right" colspan="2">Remise HT (€)</td><td class="right"><input id="discount" value="0" style="width:80px; text-align:right"/></td></tr>
            <tr><td class="right" colspan="2">TOTAL TTC (€)</td><td class="right" id="total">0.00</td></tr>
          </tfoot>
        </table>
      </div>

      <!-- CONDITIONS -->
      <div class="grid">
        <div class="row">
          <label>Acompte demandé (€ TTC, 0 si aucun)</label>
          <input id="deposit_ttc" value="0"/>
        </div>
        <div class="row">
          <label>Validité du devis (date)</label>
          <input id="valid_until" type="date"/>
        </div>
      </div>

      <div class="row">
        <label>Notes / Conditions (affichées sur le devis)</label>
        <textarea id="notes" placeholder="Délais, conditions particulières, garanties..."></textarea>
      </div>

      <div class="flex">
        <button class="btn" id="submitBtn">Générer le devis</button>
        <span id="status" class="muted"></span>
      </div>
    </div>
  </div>

<script>
/* =========================
   Réglages
========================= */
// On passe toujours par l’API Vercel (elle proxy vers n8n test ou prod)
const webhookUrl = "/api/cashpack-devis";

/* =========================
   Helpers UI / Format
========================= */
const fmt = new Intl.NumberFormat('fr-FR', { style:'decimal', maximumFractionDigits: 2, minimumFractionDigits: 2 });
const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => [...root.querySelectorAll(sel)];
const readNum = (v) => {
  const n = Number(String(v).replace(',', '.'));
  return Number.isFinite(n) ? n : 0;
};
const r2 = (n) => Math.round((n + Number.EPSILON) * 100) / 100;

/* =========================
   Récup des éléments
========================= */
const tbody = $('#itemsTable tbody');
const subtotalEl = $('#subtotal');
const totalEl = $('#total');
const addItemBtn = $('#addItem');
const tvaRateEl = $('#tva_rate');
const discountEl = $('#discount');
const submitBtn = $('#submitBtn');
const statusEl = $('#status');

/* =========================
   Lignes & Totaux
========================= */
function addRow(desc='', qty=1, unit=0) {
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input class="desc" placeholder="Désignation" value="${desc}"/></td>
    <td class="right"><input class="qty" type="number" min="0" step="1" value="${qty}" style="width:90px; text-align:right"/></td>
    <td class="right"><input class="unit" type="number" min="0" step="0.01" value="${unit}" style="width:120px; text-align:right"/></td>
  `;
  tbody.appendChild(tr);
  $$('input', tr).forEach(i => i.addEventListener('input', refreshTotals));
  refreshTotals(); saveDraft();
}
addItemBtn.addEventListener('click', () => addRow());

function getItems() {
  return $$('#itemsTable tbody tr')
    .map(tr => {
      const d = $('.desc', tr).value.trim();
      const q = readNum($('.qty', tr).value);
      const u = readNum($('.unit', tr).value);
      return { description: d, qty: Math.max(0, q|0), unit_price: r2(Math.max(0, u)), line_total_ht: r2(Math.max(0, q) * Math.max(0, u)) };
    })
    .filter(x => x.description && (x.qty > 0 || x.unit_price > 0));
}

function refreshTotals() {
  const items = getItems();
  const subtotal = r2(items.reduce((s,i)=> s + i.line_total_ht, 0));
  const tva = readNum(tvaRateEl.value);
  const discount = r2(Math.max(0, readNum(discountEl.value)));
  const base = Math.max(0, subtotal - discount);
  const tvaTotal = r2(base * (tva/100));
  const total = r2(base + tvaTotal);
  subtotalEl.textContent = fmt.format(subtotal);
  totalEl.textContent = fmt.format(total);
}

/* =========================
   Brouillon local (auto-save)
========================= */
const FIELDS = [
  'company_name','company_email','company_phone','company_siret',
  'client_name','client_email','client_phone','site_name',
  'valid_until','notes','tva_rate','discount','deposit_ttc'
];
function saveDraft() {
  const draft = Object.fromEntries(FIELDS.map(id => [id, $('#'+id)?.value ?? '']));
  draft.items = getItems();
  localStorage.setItem('cashpack_devis_draft', JSON.stringify(draft));
}
function loadDraft() {
  const raw = localStorage.getItem('cashpack_devis_draft');
  if (!raw) return;
  try {
    const d = JSON.parse(raw);
    FIELDS.forEach(id => { if ($('#'+id) && id in d) $('#'+id).value = d[id]; });
    tbody.innerHTML = '';
    (d.items && d.items.length ? d.items : [{description:"Main d'œuvre", qty:1, unit_price:50}])
      .forEach(it => addRow(it.description, it.qty, it.unit_price));
    refreshTotals();
  } catch {}
}
document.addEventListener('input', (e) => {
  if (e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA')) saveDraft();
});

/* =========================
   Bouton Submit
========================= */
function buildPayload() {
  return {
    company: {
      name: $('#company_name').value.trim(),
      email: $('#company_email').value.trim(),
      phone: $('#company_phone').value.trim(),
      siret: $('#company_siret').value.trim(),
    },
    client: {
      name: $('#client_name').value.trim(),
      email: $('#client_email').value.trim(),
      phone: $('#client_phone').value.trim(),
    },
    quote: {
      site_name: $('#site_name').value.trim(),
      valid_until: $('#valid_until').value,
      notes: $('#notes').value.trim(),
      tva_rate: readNum($('#tva_rate').value),
      discount_ht: readNum($('#discount').value),
      deposit_ttc: readNum($('#deposit_ttc').value),
    },
    items: getItems(),
  };
}

// Alt + clic sur le bouton => aperçu JSON (ne rien envoyer)
submitBtn.addEventListener('click', (ev) => {
  if (ev.altKey) {
    ev.preventDefault();
    const preview = buildPayload();
    alert("Aperçu du payload envoyé à n8n:\n\n" + JSON.stringify(preview, null, 2));
  }
});

$('#submitBtn').addEventListener('click', async (ev) => {
  ev.preventDefault();

  const payload = buildPayload();

  // Validation minimale côté client
  if (!payload.client.name) {
    statusEl.textContent = "Nom du client manquant.";
    statusEl.className = "err";
    return;
  }
  if (!payload.client.email) {
    statusEl.textContent = "Email du client manquant.";
    statusEl.className = "err";
    return;
  }
  if (payload.items.length === 0) {
    statusEl.textContent = "Ajoute au moins une ligne (Qté > 0).";
    statusEl.className = "err";
    return;
  }

  // Anti double-clic
  submitBtn.disabled = true;
  submitBtn.classList.add('secondary');
  const oldText = submitBtn.textContent;
  submitBtn.textContent = "Envoi…";
  statusEl.textContent = "Envoi…";
  statusEl.className = "muted";

  try {
    const res = await fetch(webhookUrl, {
      method: 'POST',
      mode: 'cors',
      credentials: 'omit',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });

    const text = await res.text();
    let data; 
    try { data = JSON.parse(text); } catch { data = { ok: res.ok, raw: text }; }

    if (!res.ok || data.ok === false) {
      let errMsg = "";
      switch (res.status) {
        case 400: errMsg = "Requête invalide : vérifie les champs envoyés."; break;
        case 401: errMsg = "Non autorisé : vérifie la configuration n8n/credentials."; break;
        case 404: errMsg = "Webhook introuvable : en TEST, clique 'Listen for test event' ; en PROD, active le workflow."; break;
        case 405: errMsg = "Méthode HTTP non autorisée (attendu : POST)."; break;
        case 415: errMsg = "Type de contenu non supporté (Content-Type attendu: application/json)."; break;
        case 429: errMsg = "Trop de requêtes (rate limit). Réessaie dans un instant."; break;
        case 500: errMsg = "Erreur interne côté n8n. Vérifie tes nœuds/logs."; break;
        default:  errMsg = data?.error || `Erreur inattendue (${res.status})`;
      }
      // Si n8n a renvoyé un texte utile, on l’ajoute
      if (data?.raw && typeof data.raw === 'string' && data.raw.length < 500) {
        errMsg += ` — Détail: ${data.raw}`;
      }
      throw new Error(errMsg);
    }

    statusEl.textContent = "Devis envoyé à n8n ✅";
    statusEl.className = "ok";

  } catch (e) {
    statusEl.textContent = "Erreur: " + (e?.message || "inconnue");
    statusEl.className = "err";
  } finally {
    submitBtn.disabled = false;
    submitBtn.classList.remove('secondary');
    submitBtn.textContent = oldText;
  }
});

/* =========================
   Init
========================= */
loadDraft();
if ($$('#itemsTable tbody tr').length === 0) addRow("Main d'œuvre", 1, 50);
refreshTotals();
</script>
